<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compra de Ingresso - Baile JB012</title>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: 'Arial', sans-serif;
      text-align: center;
      padding: 20px;
    }

    form {
      background: #222;
      padding: 20px;
      border-radius: 12px;
      max-width: 350px;
      margin: auto;
    }

    input, label {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      border: none;
    }

    button {
      background: #00cc88;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }

    #pixQR {
      margin-top: 20px;
    }

    canvas {
      margin-top: 20px;
    }

    #logo {
      width: 400px;
      margin-bottom: 20px;
    }

    #tipoIngresso {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin: 15px 0;
    }

    .toggle-btn {
      flex: 1;
      padding: 10px;
      text-align: center;
      background-color: #333;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: 0.3s;
    }

    .toggle-btn:hover {
      background-color: #00cc88;
    }
  </style>
</head>
<body>

  <!-- Logo -->
  <img id="logo" src="{{ url_for('static', filename='logo.png') }}" alt="Logo do Baile JB012">

  <!-- Formulário -->
  <form id="formIngresso">
    <input type="text" name="nome" id="nome" placeholder="Nome completo" required>
    <input type="text" name="cpf" id="cpf" placeholder="CPF" required>
    <input type="email" name="email" id="email" placeholder="Email" required>

    <!-- Botões para outras páginas -->
    <div id="tipoIngresso">
      <a href="/universitario" class="toggle-btn">Universitário</a>
      <a href="/promoter" class="toggle-btn">Promoter</a>
    </div>

    <button type="submit">Comprar ingresso</button>
  </form>

  <!-- QR PIX -->
  <div id="pixQR" style="display:none;">
    <h2>Escaneie o QR Code para pagar</h2>
    <canvas id="canvasPix"></canvas>
    <p id="statusPagamento">Aguardando pagamento...</p>
  </div>

  <!-- Bibliotecas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script>
    const form = document.getElementById('formIngresso');
    const pixDiv = document.getElementById('pixQR');
    const statusPagamento = document.getElementById('statusPagamento');

    let txidGlobal = '';

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const novaJanela = window.open('', '_blank', 'width=450,height=550');
      if (!novaJanela) {
        alert("Permita pop-ups no seu navegador.");
        return;
      }

      novaJanela.document.write(`
        <html><head><title>Aguardando pagamento</title></head>
        <body style="background:#111; color:white; font-family:sans-serif; text-align:center; padding-top:100px;">
          <h2>Aguardando pagamento...</h2>
        </body></html>
      `);

      const nome = document.getElementById('nome').value;
      const cpf = document.getElementById('cpf').value;
      const email = document.getElementById('email').value;

      const response = await fetch('/comprar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome, cpf, email })
      });

      const data = await response.json();

      // Gerar QR Code
      new QRious({
        element: document.getElementById('canvasPix'),
        value: data.pix_url,
        size: 250,
      });

      txidGlobal = data.txid;
      pixDiv.style.display = 'block';
      verificarPagamento(novaJanela);
    });

    async function verificarPagamento(novaJanela) {
      const interval = setInterval(async () => {
        const res = await fetch(`/confirmar/${txidGlobal}`);
        if (res.status === 200) {
          const blob = await res.blob();
          const reader = new FileReader();

          reader.onloadend = function () {
            const base64Ingresso = reader.result;

            novaJanela.document.open();
            novaJanela.document.write(`
              <html lang="pt-BR">
              <head>
                <meta charset="UTF-8">
                <title>Ingresso Confirmado</title>
                <style>
                  body {
                    background-color: #111;
                    color: white;
                    font-family: Arial, sans-serif;
                    text-align: center;
                    padding: 20px;
                  }
                  img {
                    margin-top: 20px;
                    max-width: 90%;
                  }
                  h2 {
                    margin-top: 20px;
                  }
                  #logoNova {
                    width: 300px;
                    margin-bottom: 20px;
                  }
                </style>
              </head>
              <body>
                <img id="logoNova" src="${location.origin}/static/logo.png" alt="Logo">
                <h2>✅ Obrigado! Seu ingresso foi confirmado!</h2>
                <img src="${base64Ingresso}" alt="QR Code do Ingresso" />
                <p>Apresente este código na entrada do evento.</p>
              </body>
              </html>
            `);
          };

          reader.readAsDataURL(blob); // Lê o blob como base64
          clearInterval(interval);
          statusPagamento.textContent = '✅ Pagamento confirmado!';
        } else {
          statusPagamento.textContent = 'Aguardando pagamento...';
        }
      }, 5000);
    }
  </script>
</body>
</html>
